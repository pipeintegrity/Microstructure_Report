---
title: "PPIM 2021 - Toughness Prediction Using Composition"
author: "Nathan Switzner and Joel Anderson"
date: "`r format(Sys.time(), '%B %d, %Y')`"
output: 
  html_document:
    toc: TRUE
    toc_float: TRUE
    theme: journal
    number_sections: TRUE
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning=FALSE, message=FALSE)

```

```{r libraries}
# load libraries ----------------------------------------------------------
library(janitor)
library(patchwork)
library(tidyverse)
library(readxl)
library(lubridate)
library(tune)
library(tidymodels)
library(gt)
library(modelsummary)
# library(ggplot2)

theme_set(theme_bw(18, "serif")) #set theme to save typing
```

# load TIM  

```{r TIM}
#Data import from tim_MET (formerly Metallurgical Database without Statistics_07.30.20 (2))
TIM_DATA <- read_excel("C:\\Users\\Joel\\OneDrive - RSI Pipeline Solutions\\PGE\\charpy\\TIMP_MET.xlsx",
                        sheet = "Pipe_Description", 
                        na = c("-----")) %>%
  clean_names() %>%
  rename(
    id = report_id_code,
    type = component_identifier,
    year = installation_year,
    grade = grade_per_design,
    seam_rep = seam_type,
    od_in = nominal_outside_diameter_in,
    wt_rep_in = reported_wall_thickness_in
    
  ) %>%
  select(id,
         type,
         seam_rep,
         grade,
         year,
         od_in,
         wt_rep_in) 

#Composition import from tim_MET
TIM_CHEM <- read_excel("C:\\Users\\Joel\\OneDrive - RSI Pipeline Solutions\\PGE\\charpy\\TIMP_MET.xlsx",
                        sheet = "Chemistry",
                        na = c("-----")) %>%
  clean_names() %>%
  filter(str_detect(field_or_lab_measurement,
                     "Field",
                     negate = T), material =="Base Metal") %>%  #remove field composition measurements
  rename_with(starts_with("percent_"),
              .fn = str_sub,
              start = -2) %>% #grab the last 2 characters of "x_percent...
  rename_with(starts_with("_"),
              .fn = str_remove,
              pattern = "_") %>% #get rid of "_" on some names
  rename(id = report_id_code,
         nb = cb) %>%
  # pivot_longer(cols = al:v) %>%
  # unique() %>% #get rid of dups
  mutate(across(.cols = al:v, ~ ifelse(
    str_detect(string = .x, pattern = "<"),
    as.numeric(str_remove(string = .x, pattern =  "<")) / 4,
    as.numeric(.x)
  ))) %>%
  filter(
      ni < .5 | is.na(ni),
    cu < 1 | is.na(cu),
    ti < 1 | is.na(ti),
    cr < .3 | is.na(cr),
    al < 1 | is.na(al),
    c < 0.4 | c > 0.03 | is.na(c),
    si < 0.35 | is.na(si),
    mn < 3| is.na(mn),
    mo < 0.1 | is.na(mo)
  ) %>% #strip out the < sign and divide by 2
  #screen out bad numbers
  mutate(
    al = ifelse(al > .06 | al < .0001, NA, al),
    c = ifelse(c > .4 | c < .03, NA, c),
    mn = ifelse(mn > 2 | mn < .2, NA, mn),
    p = ifelse(p > 0.16 | p < 0.001, NA, p),
    s = ifelse(s > 0.08 | s < 0.001, NA, s),
    si = ifelse(si > 0.5 | si < 0.005, NA, si),
    nb = ifelse(nb > 0.15 | nb < 0.0001, NA, nb),
    v = ifelse(v > 0.15 | v < 0.0001, NA, v),
    ti = ifelse(ti > 0.15 | ti < 0.0001, NA, ti),
    ni = ifelse(ni > 0.3 | ni < 0.0001, NA, ni),
    cu = ifelse(cu > 0.5 | cu < 0.0001, NA, cu),
    mo = ifelse(mo > 0.15 | mo < 0.0001, NA, mo),
    cr = ifelse(cr > 0.2 | cr < 0.0001, NA, cr),
    b = ifelse(b > 0.001 | b < 0.00001, NA, b),
    ca = ifelse(ca > 0.01 | ca < 0.00001, NA, ca)
  )

TIM_CVN <- read_excel("C:\\Users\\Joel\\OneDrive - RSI Pipeline Solutions\\PGE\\charpy\\TIMP_MET.xlsx",
                          sheet = "Charpy")  %>%
  clean_names() %>%
  rename(
    id = report_id_code,
    location = specimen_location,
    temp = test_temperature_f,
    charpy_size = specimen_thickness_mm,
    absorbed_energy = measured_energy_absorbed_ft_lbs,
    shear_area = shear_area_percent
  ) %>%
  mutate(across(temp:absorbed_energy, as.numeric), 
         shear_area = as.numeric(str_remove(string = shear_area,pattern = c("<", ">")))) %>%
  filter(str_detect(location, "Base Metal"), 
         shear_area<=100) %>% #removing weld tests
  select(id,
         location,
         temp,
         charpy_size,
         absorbed_energy,
         shear_area)

#Data import from TIMP_MET (formerly Metallurgical Database without Statistics_07.30.20 (2))
TIM_WT <- read_excel("C:\\Users\\Joel\\OneDrive - RSI Pipeline Solutions\\PGE\\charpy\\TIMP_MET.xlsx",
                      sheet = "WT & Seam Type", 
                     na = "-----") %>%
  clean_names() %>%
  rename(
    id = report_id_code,
    wt_meas_in = average_wall_thickness_in,
    seam_id = identified_seam_type,
    max_wt = maximum_measured_wall_thickness_in,
    min_wt = minimum_measured_wall_thickness_in,
    rep_wt = reported_wall_thickness_in
  ) %>%
  mutate(
    min_wt = as.numeric(min_wt),
    max_wt = as.numeric(max_wt),
    rep_wt = as.numeric(rep_wt),
    rep_wt = ifelse(is.na(rep_wt), (min_wt + max_wt) / 2, rep_wt),
    wt_in = ifelse(is.na(wt_meas_in), rep_wt, wt_meas_in)
  ) %>%
  #Clean-up wt by using rep or average of min max
  select(id,
         wt_in,
         seam_id)

TIM_DATA_WT <- full_join(TIM_DATA, TIM_WT, by = "id") %>%
mutate(type = ifelse(str_detect(string = type,pattern = "Pipe"),
"Pipe",
type),
wt_in = as.numeric(ifelse(is.na(wt_in), wt_rep_in, wt_in)))

TIM_JOIN <- TIM_DATA_WT %>%
full_join(TIM_CHEM, by = "id") %>%
# full_join(TIMP_WT, by = "id") %>%
full_join(TIM_CVN, by = "id") %>%
filter(wt_in>0.13) %>%
  mutate(
    SA_SS = (shear_area + 5) / 110,
    #calc subsize shear area and rename
    t_ss_in = charpy_size / 25.4,
    #calc subsize charpy thickness in inches
    sigB = (-12.736) * (t_ss_in / .394) ^ 2 +
      39.984 * (t_ss_in / 0.394) + 4.6897,
    #calc sigmoidal parameter B
    sigA = (-21.812) * (t_ss_in / 0.394) ^ 2 + 68.279 * (t_ss_in / 0.394) +
      8.4349,
    #calc sigmoidal parameter A
    TT_SS_F =  (temp - sigB * log(SA_SS /
                                          (1 - SA_SS)) + sigA) * 0.95 ,
    TT_FS_F = TT_SS_F + 66 * (wt_in ^ 0.55) *
      (t_ss_in ^ (-.7) - 0.394 ^ (-.7)),
    
    CVN_SS = absorbed_energy,
    #rename subsize CVN
    CVN_US_SS = CVN_SS / (0.9 * SA_SS + 0.1),
    #calc subsize CVN upper shelf energy from subsize CVN and subsize shear area
    CVN_US_FS = CVN_US_SS * 0.394 / t_ss_in,
    #calc fullsize CVN upper shelf energy
    
  ) %>%
  select(id,
         wt_in,
         CVN_US_FS,
         TT_FS_F,
         al,
        c,
        cr,
        cu,
        mn,
        mo,
        nb,
        ni,
        p,
        s,
        si,
        v) %>%
  unique() %>%
  group_by(id) %>%
  summarize(across(
    .cols = wt_in:v,
    .fns = mean,
    na.rm = T
  )) %>%
  filter(!(is.na(CVN_US_FS))) %>%
  mutate(source = "TIM")

```

# load IND  

```{r IND}
IND <- read_excel("C:\\Users\\Joel\\OneDrive - RSI Pipeline Solutions\\PGE\\charpy\\IndustryCharpy3.xlsx",
                  sheet = "Industry_Charpy") %>%
  clean_names() %>%
  filter(
    str_detect(pipe_grade, "Iron", negate = T)) %>%
      #remove iron
      rename_with(.fn = str_remove, pattern = "percent_") %>%
  filter(
      ni < .5 | is.na(ni),
    cu < 1 | is.na(cu),
    ti < 1 | is.na(ti),
    cr < .3 | is.na(cr),
    al < 1 | is.na(al),
    c < 0.4 | c > 0.03 | is.na(c),
    si < 0.35 | is.na(si),
    mn < 3| is.na(mn),
    mo < 0.1 | is.na(mo)
  ) %>%
      #remove all the "percent_" from names
      mutate(
        al = ifelse(al > .06 | al < .0001, NA, al),
        c = ifelse(c > .4 | c < .03, NA, c),
        mn = ifelse(mn > 2 | mn < .2, NA, mn),
        p = ifelse(p > 0.16 | p < 0.001, NA, p),
        s = ifelse(s > 0.08 | s < 0.001, NA, s),
        si = ifelse(si > 0.5 | si < 0.005, NA, si),
        nb = ifelse(nb > 0.15 | nb < 0.0001, NA, nb),
        v = ifelse(v > 0.15 | v < 0.0001, NA, v),
        ti = ifelse(ti > 0.15 | ti < 0.0001, NA, ti),
        ni = ifelse(ni > 0.3 | ni < 0.0001, NA, ni),
        cu = ifelse(cu > 0.5 | cu < 0.0001, NA, cu),
        mo = ifelse(mo > 0.15 | mo < 0.0001, NA, mo),
        cr = ifelse(cr > 0.2 | cr < 0.0001, NA, cr),
        b = ifelse(b > 0.001 | b < 0.00001, NA, b),
        ca = ifelse(ca > 0.01 | ca < 0.00001, NA, ca),
        thickness = ifelse(thickness > 1 |
                             thickness < 0.05,
                           NA,
                           thickness),
        full_size_equiv = ifelse(full_size_equiv > 350 |
                                   full_size_equiv < 1,
                                 NA,
                                 full_size_equiv),
        full_wt_trans_temp = ifelse(
          full_wt_trans_temp < (-100) |
            full_wt_trans_temp > 300,
          NA,
          full_wt_trans_temp
        )
      ) %>%
      rename(
        t_ss_in = thickness,
        CVN_US_FS = full_size_equiv,
        wt_in = pipe_wt,
        TT_SS_F = trans_temp,
        TT_FS_F = full_wt_trans_temp,
        year = pipe_vintage
      ) %>%
      mutate(across(wt_in:TT_FS_F, as.numeric)) %>%
      mutate(
        CVN_US_FS = ifelse(CVN_US_FS > 250 |
                             CVN_US_FS < 10,
                           NA,
                           CVN_US_FS),
        TT_FS_F = TT_FS_F + 66 * (wt_in ^ 0.55) * (t_ss_in ^ (-.7) - .394 ^ (-.7))
      ) %>%  #calc full sz 85% trans temp
      select(
        al,
        c,
        cr,
        cu,
        mn,
        mo,
        nb,
        ni,
        p,
        s,
        si,
        v,
        CVN_US_FS,
        TT_FS_F,
        year
      ) %>%
      mutate(CVN_US_FS = ifelse(
        CVN_US_FS > 250 |
          CVN_US_FS < -50,
        NA,
        CVN_US_FS
      )) %>%
      filter(!(is.na(CVN_US_FS))) %>%
      mutate(source = "IND")
    
```

# load ECA  

```{r ECA_DATA}
ECA_DATA <- read_excel("MasterDB-SQL-2021-07-28 NS.xlsx",
                       sheet = "Features")  %>%
  clean_names() %>%
  rename(feature = feature_id) %>%
  mutate(year = ifelse(is.na(mfr_year),
                       pg_e_install_year,
                       mfr_year)) %>%
  select(group,
         feature,
         grade,
         od_inch,
         year,
         seam_type) 


```


```{r ECA_CHEM}
ECA_CHEM <- read_excel("MasterDB-SQL-2021-07-28 NS.xlsx",
                        sheet = "Composition")  %>%
  clean_names() %>%
   filter(str_detect(tool, "Lab")) %>%
   mutate(across(.cols = c:ca, ~ ifelse(str_detect(string = .x, pattern = "<"),
        as.numeric(str_remove(string =.x, pattern =  "<"))/ 4,
    as.numeric(.x)))) %>% 
  filter(
   ni < .5 | is.na(ni),
    cu < 1 | is.na(cu),
    ti < 1 | is.na(ti),
    cr < .3 | is.na(cr),
    al < 1 | is.na(al),
    c < 0.4 | c > 0.03 | is.na(c),
    si < 0.35 | is.na(si),
    mn < 3| is.na(mn),
    mo < 0.1 | is.na(mo)
  ) %>%
  mutate(
    c = ifelse(c > 0.4 | c < .03, NA, c),
    mn = ifelse(mn > 2 | mn < .2, NA, mn),
    p = ifelse(p > 0.16 | p < 0.001, NA, p),
    s = ifelse(s > 0.08 | s < 0.001, NA, s),
    si = ifelse(si > 0.5 | si < 0.005, NA, si),
    nb = ifelse(nb > 0.15 | nb < 0.0001, NA, nb),
    v = ifelse(v > 0.15 | v < 0.0001, NA, v),
    ti = ifelse(ti > 0.15 | ti < 0.0001, NA, ti),
    ni = ifelse(ni > 0.3 | ni < 0.0001, NA, ni),
    cu = ifelse(cu > 0.5 | cu < 0.0001, NA, cu),
    mo = ifelse(mo > 0.15 | mo < 0.0001, NA, mo),
    cr = ifelse(cr > 0.3 | cr < 0.0001, NA, cr),
    b = ifelse(b > 0.001 | b < 0.00001, NA, b),
    ca = ifelse(ca > 0.01 | ca < 0.00001, NA, ca)
  )  %>% 
  group_by(group, feature) %>%
  summarise(across(
    .cols = c:ca,
    .fns = mean,
    na.rm = T
  )) %>%
  select(group,
         feature,
         al,
        c,
        cr,
        cu,
        mn,
        mo,
        nb,
        ni,
        p,
        s,
        si,
        v)
```


```{r ECA_CVN_WT}
ECA_WT <- read_excel("MasterDB-SQL-2021-07-28 NS.xlsx",
                     sheet = "Wall Thickness")  %>%
  clean_names() %>%
  filter(str_detect(location_type, "AFG", negate = T)) %>%  #remove any wall thickness measurements after grind
  group_by(group, feature) %>%
  summarize(wt_in = mean(measurement_in, na.rm = T)) %>%
  select(group,
         feature,
         wt_in)

ECA_CVN <- read_excel("MasterDB-SQL-2021-07-28 NS.xlsx",
                         sheet = "Charpy")  %>%
  clean_names() %>% 
  full_join(ECA_WT, by= c("group", "feature")) %>% 
  filter(str_detect(location, "Base")) %>% #removing weld tests
  mutate(
    SA_SS = (shear_area_percent + 5) / 110,
    t_ss_in = charpy_size_mm / 25.4,
    #calc subsize charpy thickness in inches
    sigB = (-12.736) * (t_ss_in / .394) ^ 2 +
      39.984 * (t_ss_in / 0.394) + 4.6897,
    #calc sigmoidal parameter B
    sigA = (-21.812) * (t_ss_in / 0.394) ^ 2 + 68.279 * (t_ss_in / 0.394) +
      8.4349,
    #calc sigmoidal parameter A
    TT_SS_F =  (temperature_f - sigB * log(SA_SS /
                                          (1 - SA_SS)) + sigA) * 0.95 ,
    TT_FS_F = TT_SS_F + 66 * (wt_in ^ 0.55) *
      (t_ss_in ^ (-.7) - 0.394 ^ (-.7)),
    
    CVN_SS = absorbed_energy_ft_lbs,
    #rename subsize CVN
    
    #calc subsize shear area and rename
    CVN_US_SS = CVN_SS / (0.9 * SA_SS + 0.1),
    #calc subsize CVN upper shelf energy from subsize CVN and subsize shear area
    CVN_US_FS = CVN_US_SS * 0.394 / t_ss_in
    #calc fullsize CVN upper shelf energy
  ) %>%
  group_by(group, feature) %>%
  summarize(
    CVN_US_FS = mean(CVN_US_FS, na.rm = T),
    TT_FS_F = mean(TT_FS_F, na.rm = T)
  ) %>%
  select("group", "feature", "CVN_US_FS", "TT_FS_F")
  

```

```{r ECA_JOIN}

ECA_JOIN <- ECA_DATA %>%
  full_join(ECA_CHEM,
            by = c("feature", "group")) %>%
  full_join(ECA_CVN,
            by = c("feature", "group")) %>%
  full_join(ECA_WT,
            by = c("feature", "group")) %>% 
  select(c(group,
           feature,
           year,
           wt_in,
           CVN_US_FS,
           TT_FS_F,
           al,
        c,
        cr,
        cu,
        mn,
        mo,
        nb,
        ni,
        p,
        s,
        si,
        v)) %>%
  mutate(year = as.numeric(year)) %>% 
  filter(!(is.na(CVN_US_FS))) %>%
  mutate(source = "ECA")

```

# Histograms  

## CVN TIM  

```{r histo CVN TIM, fig.width=4}
ggplot(TIM_JOIN, aes(x=CVN_US_FS)) +
  geom_histogram(color="black", binwidth = 20 , fill="steelblue")+
  scale_x_continuous(limits = c(0,300))+
  labs(x = "CVN Upper Shelf (ft-lbs")
```

## CVN ECA  

```{r histo CVN ECA, fig.width=4}
ggplot(ECA_JOIN, aes(x=CVN_US_FS)) +
  geom_histogram(color="black", binwidth = 20 , fill="steelblue")+
  scale_x_continuous(limits = c(0,300))+
  labs(x = "CVN Upper Shelf (ft-lbs")
```

## TT TIM  

```{r histo TT TIM, fig.width=4}
ggplot(TIM_JOIN, aes(x=TT_FS_F)) +
  geom_histogram(color="black", binwidth = 20 , fill="steelblue")+
  scale_x_continuous(limits = c(-50,250))+
  labs(x = "Transition Temp. (?F)")
```

## TT ECA  

```{r histo TT ECA, fig.width=4}
ggplot(ECA_JOIN, aes(x=TT_FS_F)) +
  geom_histogram(color="black", binwidth = 20 , fill="steelblue")+
  scale_x_continuous(limits = c(-50,250))+
  labs(x = "Transition Temp. (?F)")

```

```{r TIM_ECA_IND bind}
TIM_ECA_IND <- bind_rows(ECA_JOIN,
                      TIM_JOIN,
                      IND) %>%
  select(al,
        c,
        cr,
        cu,
        mn,
        mo,
        nb,
        ni,
        p,
        s,
        si,
        v,
         CVN_US_FS,
         TT_FS_F,
         # nacount, 
         source) 

  nacount = rowSums(is.na(TIM_ECA_IND))
TIM_ECA_IND <- bind_cols(TIM_ECA_IND, nacount = nacount) %>% 
  unique()

TIM_ECA_ONLY <- TIM_ECA_IND %>% filter(source!= "IND")
```

# CVN element effects

```{r CVN element effects TIM, fig.width=8.5}
TIM_JOIN %>%
  filter(CVN_US_FS<250) %>% 
  pivot_longer(cols = al:v) %>%
  ggplot(aes(value, CVN_US_FS, col = name)) +
  geom_point(alpha = 0.5, show.legend = F) +
  # scale_x_log10() +
  # scale_y_log10() +
  facet_wrap(~ name, scales = "free_x") +
  scale_y_continuous(limits = c(0,300))+
  geom_smooth(
    method = "lm",
    se = F,
    show.legend = F,
    col = 'black'
  ) +
  theme_bw(16, "serif") +
  labs(title = "Element Effects on CVN Upper Shelf Energy (Vendor 1)", 
       y = "Upper Shelf Energy (Ft-lbs)", 
       x = "Element Content (wt%)")+
  theme(axis.text.x = element_text(size=11), 
        panel.spacing.x = unit(1.5,"lines"))
```

```{r CVN element effects ECA, fig.width=8.5}
ECA_JOIN %>%
  filter(CVN_US_FS<250) %>% 
  pivot_longer(cols = al:v) %>%
  ggplot(aes(value, CVN_US_FS, col = name)) +
  geom_point(alpha = 0.5, show.legend = F) +
  # scale_x_log10() +
  # scale_y_log10() +
  facet_wrap(~ name, scales = "free_x") +
  scale_y_continuous(limits = c(0,300))+
  geom_smooth(
    method = "lm",
    se = F,
    show.legend = F,
    col = 'black'
  ) +
  theme_bw(16, "serif")+
  labs(title = "Element Effects on CVN Upper Shelf Energy (Vendor 2)", 
       y = "Upper Shelf Energy (Ft-lbs)", 
       x = "Element Content (wt%)")+
  theme(axis.text.x = element_text(size=11), 
        panel.spacing.x = unit(1.5,"lines"))

```

```{r tt elemental effects TIM, fig.width=8.5}
TIM_JOIN %>%
  pivot_longer(cols = al:v) %>%
  ggplot(aes(value, TT_FS_F, col = name)) +
  geom_point(alpha = 0.5, show.legend = F) +
  # scale_y_log10() +
  facet_wrap( ~ name, scales = "free_x") +
  scale_y_continuous(limits = c(-100,200))+
  geom_smooth(
    method = "lm",
    se = F,
    show.legend = F,
    col = 'black'
  ) +
  theme_bw(16, "serif")+
  labs(title = "Element Effects on Transition Temperature (Vendor 1)", 
       y = "Transition Temperature (?F)", 
       x = "Element Content (wt%)")+
  theme(axis.text.x = element_text(size=11), 
        panel.spacing.x = unit(1.5,"lines"))

```

```{r tt elemental effects ECA, fig.width = 8.5}
ECA_JOIN %>%
  pivot_longer(cols = al:v) %>%
  ggplot(aes(value, TT_FS_F, col = name)) +
  geom_point(alpha = 0.5, show.legend = F) +
  # scale_y_log10() +
  facet_wrap( ~ name, scales = "free_x") +
  scale_y_continuous(limits = c(-100,200))+
  geom_smooth(
    method = "lm",
    se = F,
    show.legend = F,
    col = 'black'
  ) +
  theme_bw(16, "serif")+
  labs(title = "Element Effects on Transition Temperature (Vendor 2)", 
       y = "Transition Temperature (F)", 
       x = "Element Content (wt%)")+
  theme(axis.text.x = element_text(size=11), 
        panel.spacing.x = unit(1.5,"lines"))
```

# Data split to train and test

```{r split train and test}
split <- 
  initial_split(TIM_ECA_ONLY,prop = 0.80)

train <- training(split) 
test <- testing(split)
# train_low <- train %>% filter(CVN_US_FS<150)

set.seed(42)

train_cvn_c_v <-
  train %>%
  filter(CVN_US_FS < 250) %>%
  filter(TT_FS_F > 0) %>% 
  select(CVN_US_FS,  c:v) %>%
  drop_na()

test_cvn_c_v <-
  test %>%
  filter(CVN_US_FS < 250) %>%
  filter(TT_FS_F > 0) %>% 
  select(CVN_US_FS,  c:v) %>%
  drop_na()

train_tt_c_v <-
  train %>%
  filter(CVN_US_FS < 250) %>%
  filter(TT_FS_F > 0) %>% 
  select(TT_FS_F,  c:v) %>%
  drop_na()

test_tt_c_v <-
  test %>%
  filter(CVN_US_FS < 250) %>%
  filter(TT_FS_F > 0) %>% 
  select(TT_FS_F ,  c:v) %>%
  drop_na()

train_cvn_c_mn_s_si <-
  train %>%
  filter(CVN_US_FS < 250) %>%
  filter(TT_FS_F > 0) %>% 
  select(CVN_US_FS, c, mn, s, si) %>%
  drop_na()

test_cvn_c_mn_s_si <-
  test %>%
  filter(CVN_US_FS < 250) %>%
  filter(TT_FS_F > 0) %>% 
  select(CVN_US_FS, c, mn, s, si) %>%
  drop_na()

train_tt_c_mn_s_si <-
  train %>%
  filter(CVN_US_FS < 250) %>%
  filter(TT_FS_F > 0) %>% 
  select(TT_FS_F, c, mn, s, si) %>%
  drop_na()

test_tt_c_mn_s_si <-
  test %>%
  filter(CVN_US_FS < 250) %>%
  filter(TT_FS_F > 0) %>% 
  select(TT_FS_F , c, mn, s, si) %>%
  drop_na()
```

# lm definition

```{r lm definition}
lm_model <- linear_reg() %>% 
            set_engine('lm') %>% # adds lm implementation of linear regression
            set_mode('regression')
```

# CVN lm based on c:v

```{r cvn lm c:v}
cvn_lm_a <- lm_model %>% 
  fit(CVN_US_FS ~  ., data = train_cvn_c_v)

cvn_lm_a_results = predict(cvn_lm_a,
                             new_data = test_cvn_c_v) %>% 
  bind_cols(test_cvn_c_v$CVN_US_FS) %>% 
  rename(predicted = .pred,
         observed = ...2) %>% 
  mutate(model = "lm_a")

rsq(cvn_lm_a_results, 
     truth = observed,
     estimate = predicted)
```

```{r cvn lm c:v rmse}
rmse(cvn_lm_a_results, 
     truth = observed,
     estimate = predicted)
```

```{r cvn lm c:v plot}
ggplot(
  data = cvn_lm_a_results,
  mapping = aes(
    x = predicted,
    y = observed,
    color = model,
    shape = model
  )
) +
  geom_point(alpha = 0.5,
             size = 1) +
  coord_obs_pred() +
  geom_abline(col = 'grey50',
              lty = 3,
              lwd = 1.1) +
  geom_smooth(method = "lm",
              se = F #,
              #col = 'orange'
              ) +
  labs(
    title = "CVN Upper Shelf Energy (Ft-lbs)",
    subtitle = "lm_a = S/Si/C/Mo/Mn/Cr/Nb/P/Cu/Ni/V",
    x = "Predicted",
    y = "Observed"
  )

```

# CVN lm based on c mn s si  

```{r cvn lm c mn s si}
cvn_lm_b <- lm_model %>% 
  fit(CVN_US_FS ~  ., data = train_cvn_c_mn_s_si)

cvn_lm_b_results = predict(cvn_lm_b,
                             new_data = test_cvn_c_mn_s_si) %>% 
  bind_cols(test_cvn_c_mn_s_si$CVN_US_FS) %>% 
  rename(predicted = .pred,
         observed = ...2) %>% 
  mutate(model = "lm_b")

rsq(cvn_lm_b_results, 
     truth = observed,
     estimate = predicted)
```

```{r cvn lm c mn s si rmse}
rmse(cvn_lm_b_results, 
     truth = observed,
     estimate = predicted)
```

```{r cvn lm c mn s si plot}
cvn_lm_results_bind_a_b <-
         bind_rows(cvn_lm_b_results, cvn_lm_a_results)

ggplot(cvn_lm_results_bind_a_b,
       aes(x = predicted,
           y = observed,
           color = model,
           shape = model
                     )) +
  geom_point(alpha=0.6, size=1)+
  coord_obs_pred()+
  geom_abline(col='grey50',
              lty=3, 
              lwd=1.1)+
  labs(title = "CVN Upper Shelf Energy (Ft-lbs)", 
       subtitle = "lm_a = all elements; lm_b = s/si/c/mn",
       x="Predicted",
       y="Observed")+
  scale_color_brewer(type = "div", palette = "Set1")
```

# cvn lm based on log s log c and si  

```{r cvn lm log}
cvn_lm_c <- lm_model %>% 
  fit(CVN_US_FS ~ log(s) + log(c) + si, data = train_cvn_c_mn_s_si)

cvn_lm_c_results = predict(cvn_lm_c,
                             new_data = test_cvn_c_mn_s_si) %>% 
  bind_cols(test_cvn_c_mn_s_si$CVN_US_FS) %>% 
  rename(predicted = .pred,
         observed = ...2) %>% 
  mutate(model = "lm_c")
```

```{r cvn lm log r}
metrics(cvn_lm_c_results, 
     truth = observed,
     estimate = predicted)
```

```{r cvn lm log rsme}
# rmse(cvn_lm_c_results, 
#      truth = observed,
#      estimate = predicted)
```

```{r cvn lm logc logs si plot}
cvn_lm_results_bind_a_b_c <-
         mutate(bind_rows(cvn_lm_b_results, cvn_lm_a_results, cvn_lm_c_results))

ggplot(cvn_lm_results_bind_a_b_c,
       aes(x = predicted,
           y = observed,
           color = model,
           # shape = model
                     )) +
  geom_point(alpha=0.65, 
             size=1.25,
             position = "jitter")+
  coord_obs_pred()+
  geom_abline(col='grey50',
              lty=3, 
              lwd=1.1)+
  labs(title = "CVN Upper Shelf Energy (Ft-lbs)", 
       subtitle = "lm_c = log(S)/log(C)/Si",
       x="Predicted",
       y="Observed")+
  scale_color_brewer(type = "div", palette = "Set1")
```


# CVN rf c:v model variable importance

```{r rf spec}
rf_spec <- rand_forest(
  mode = "regression",
  trees = 1000,
  mtry = 3,
  min_n = 5
  ) %>%
  set_engine("ranger",
             importance = "impurity" ,
             num.threads = 6)
```

```{r rf c to v}
cvn_rf_fit_a <- rf_spec %>%
  fit(CVN_US_FS ~ . , data = train_cvn_c_v)

cvn_predictions_rf_a = cvn_rf_fit_a %>%
  predict(new_data = test_cvn_c_v) %>%
  mutate(truth = test_cvn_c_v$CVN_US_FS, 
         model = "rf_a")%>% 
  rename(predicted = .pred,
         observed = truth) 
```

```{r cvn rf variable importance}
importance_cvn <- tibble(
  imp = cvn_rf_fit_a$fit$variable.importance,
  element = names(cvn_rf_fit_a$fit$variable.importance))

ggplot(importance_cvn,
       aes(x = reorder(element, -imp),
           imp)) +
  geom_col(width = 0.25,
           fill = 'steelblue') +
  labs(title = "Variable Importance for CVN Upper Shelf Energy Prediction",
       x = "Model Variable",
       y = "Importance (Arbitrary Units)") +
  theme_bw(16, "serif")
```

# cvn rf based on all c to v
```{r rf a _c to v again}
cvn_rf_fit_a <- rf_spec %>%
  fit(CVN_US_FS ~ . , data = train_cvn_c_v)

cvn_predictions_rf_a = cvn_rf_fit_a %>%
  predict(new_data = test_cvn_c_v) %>%
  mutate(truth = test_cvn_c_v$CVN_US_FS, 
         model = "rf_a")%>% 
  rename(predicted = .pred,
         observed = truth) 
```

```{r cvn rf a performance}
cvn_predictions_rf_a %>% 
  metrics(observed, predicted) %>% 
  gt()
```

```{r cvn rf a plot}
ggplot(cvn_predictions_rf_a,
       aes(x = predicted,
           y = observed,
           color = model,
           shape = model
                     )) +
  geom_point(alpha=0.5, size=1)+
  coord_obs_pred()+
  geom_abline(col='grey50',
              lty=3, 
              lwd=1.1)+
    geom_smooth(method = "lm",
              se = F #,
              #col = 'orange'
              )+
  labs(title = "CVN Upper Shelf Energy (Ft-lbs)", 
       subtitle = "Random Forest Model: S/Si/C/Mo/Mn/Cr/Nb/P/Cu/Ni/V",
       x="Predicted",
       y="Observed",
       caption = )
```

# CVN rf based on c, mn, s, si  

```{r rf c, mn, s, si}
cvn_rf_fit_b <- rf_spec %>%
  fit(CVN_US_FS ~ . , data = train_cvn_c_mn_s_si)

cvn_predictions_rf_b = cvn_rf_fit_b %>%
  predict(new_data = test_cvn_c_mn_s_si) %>%
  mutate(truth = test_cvn_c_mn_s_si$CVN_US_FS, 
         model = "rf_b")%>% 
  rename(predicted = .pred,
         observed = truth) 
```

```{r cvn rf b performance}
cvn_predictions_rf_b %>% 
  metrics(observed, predicted) %>% 
  gt()
```

```{r rf b plot}
cvn_rf_results_bind <-
         mutate(bind_rows(cvn_predictions_rf_a, cvn_predictions_rf_b))

ggplot(cvn_rf_results_bind,
       aes(x = predicted,
           y = observed,
           color = model,
           # shape = model
                     )) +
  geom_point(alpha=0.6, size=1, position = "jitter")+
  coord_obs_pred()+
  geom_abline(col='grey50',
              lty=3, 
              lwd=1.1)+
  labs(title = "CVN Upper Shelf Energy (Ft-lbs)", 
       subtitle = "rf_a = all elements; rf_b = S/Si/C/Mn",
       x="Predicted",
       y="Observed",
       caption = )+
  # theme(plot.title = element_text(size=16), 
  #       plot.subtitle = element_text(size=14))+
  scale_color_brewer(type = "div", palette = "Set1")
```

# Comparison of lm to Rf  

```{r lm rf comparison plot}
cvn_lm_rf_results_bind <-
         mutate(bind_rows(cvn_lm_c_results, cvn_predictions_rf_b))

ggplot(cvn_lm_rf_results_bind,
       aes(x = predicted,
           y = observed,
           color = model,
           # shape = model
                     )) +
  geom_point(alpha=0.5, size=1, position = "jitter")+
  coord_obs_pred()+
  geom_abline(col='grey50',
              lty=3, 
              lwd=1.1)+
  geom_smooth(method = "lm",
              se = F 
              )+
  labs(title = "CVN Upper Shelf Energy (Ft-lbs)", 
       subtitle = "lm_c = log(S)/log(C)/Si; rf_b = S/Si/C/Mn",
       x="Predicted",
       y="Observed",
       caption = )
```

# TT random forest variable importance  

```{r tt rf c to v}
tt_rf_fit_a <- rf_spec %>%
  fit(TT_FS_F ~ . , data = train_tt_c_v)

tt_predictions_rf_a = tt_rf_fit_a %>%
  predict(new_data = test_tt_c_v) %>%
  mutate(truth = test_tt_c_v$TT_FS_F, 
         model = "rf_a")%>% 
  rename(predicted = .pred,
         observed = truth) 
```

```{r cvn rf variable importance b}
importance_tt <- tibble(
  imp = tt_rf_fit_a$fit$variable.importance,
  element = names(tt_rf_fit_a$fit$variable.importance))

ggplot(importance_tt,
       aes(x = reorder(element, -imp),
           imp)) +
  geom_col(width = 0.25,
           fill = 'steelblue') +
  labs(title = "Variable Importance for SATT Prediction",
       x = "Model Variable",
       y = "Importance (Arbitrary Units)") +
  theme_bw(16, "serif")
```

# TT RF for c to v  

```{r tt rf c to v again}
tt_rf_fit_a <- rf_spec %>%
  fit(TT_FS_F ~ . , data = train_tt_c_v)

tt_predictions_rf_a = tt_rf_fit_a %>%
  predict(new_data = test_tt_c_v) %>%
  mutate(truth = test_tt_c_v$TT_FS_F, 
         model = "rf_a")%>% 
  rename(predicted = .pred,
         observed = truth) 
```

```{r tt rf a performance}
tt_predictions_rf_a %>% 
  metrics(observed, predicted) %>% 
  gt()
```

```{r tt rf a plot}
ggplot(tt_predictions_rf_a,
       aes(x = predicted,
           y = observed,
           color = model,
           shape = model
                     )) +
  geom_point(alpha=0.5, size=1)+
  coord_obs_pred()+
  geom_abline(col='grey50',
              lty=3, 
              lwd=1.1)+
    geom_smooth(method = "lm",
              se = F #,
              #col = 'orange'
              )+
  labs(title = "Transition Temperature (?F)", 
       subtitle = "rf_a = S/Si/C/Mo/Mn/Cr/Nb/P/Cu/Ni/V",
       x="Predicted",
       y="Observed",
       caption = )
```

# TT RF for mn, c, s, si  

```{r tt rf mn, c, s, si}
tt_rf_fit_b <- rf_spec %>%
  fit(TT_FS_F ~ . , data = train_tt_c_mn_s_si)

tt_predictions_rf_b = tt_rf_fit_b %>%
  predict(new_data = test_tt_c_mn_s_si) %>%
  mutate(truth = test_tt_c_mn_s_si$TT_FS_F, 
         model = "rf_b")%>% 
  rename(predicted = .pred,
         observed = truth) 
```

```{r tt rf b performance}
tt_predictions_rf_b %>% 
  metrics(observed, predicted) %>% 
  gt()
```

```{r tt rf b plot}
tt_predictions_rf_bind =
  mutate(bind_rows(tt_predictions_rf_a, tt_predictions_rf_b))

ggplot(tt_predictions_rf_bind,
       aes(x = predicted,
           y = observed,
           color = model,
           # shape = model
                     )) +
  geom_point(alpha=0.6, size=1, position = "jitter")+
  coord_obs_pred()+
  geom_abline(col='grey50',
              lty=3, 
              lwd=1.1)+
  labs(title = "Transition Temperature (?F)", 
       subtitle = "rf_a = all elements; rf_b = Mn/C/S/Si",
       x="Predicted",
       y="Observed",
       caption = )
```

# microstructure data  

```{r data for micro}
ECA_DATA <- read_excel("ECA_PLUS_PRCI.xlsx",
                       sheet = "Features")  %>%
  clean_names() %>%
  filter(str_detect(group, "Calibration Blocks", negate = T)) %>%  #remove SS and Al
  mutate(year = ifelse(is.na(mfr_year) | 
                         mfr_year == "unknown",
                       pg_e_install_year,
                       mfr_year)) %>% 
           #mfr_year pg_e_install_year
  rename(feature = feature_id)
```

```{r compo for micro}
ECA_COMPO <- read_excel("ECA_PLUS_PRCI.xlsx",
                        sheet = "Composition")  %>%
  clean_names() %>%
  filter(str_detect(tool, "Lab")) %>%
  pivot_longer(cols = c:ca) %>%
  mutate(value = ifelse(
    str_detect(value, pattern = "<"),
    as.numeric(str_remove(value, "<")) / 2,
    as.numeric(value) #strip out the < sign and divide by 2
  )) %>%
  pivot_wider(names_from = name,
              values_from = value)  %>% #pivot back to wide format
  mutate( #screen out bad numbers
    al = ifelse(al > .06 | al < .0001, NA, al),
    c = ifelse(c > .4 | c < .03, NA, c),
    mn = ifelse(mn > 2 | mn < .2, NA, mn),
    p = ifelse(p > 0.16 | p < 0.001, NA, p),
    s = ifelse(s > 0.08 | s < 0.001, NA, s),
    si = ifelse(si > 0.5 | si < 0.005, NA, si),
    nb = ifelse(nb > 0.15 | nb < 0.0001, NA, nb),
    v = ifelse(v > 0.15 | v < 0.0001, NA, v),
    ti = ifelse(ti > 0.15 | ti < 0.0001, NA, ti),
    ni = ifelse(ni > 0.3 | ni < 0.0001, NA, ni),
    cu = ifelse(cu > 0.5 | cu < 0.0001, NA, cu),
    mo = ifelse(mo > 0.15 | mo < 0.0001, NA, mo),
    cr = ifelse(cr > 0.2 | cr < 0.0001, NA, cr),
    b = ifelse(b > 0.001 | b < 0.00001, NA, b),
    ca = ifelse(ca > 0.01 | ca < 0.00001, NA, ca)
  ) %>%
  group_by(group, feature) %>%
  summarise(across(
    .cols = c:ca,
    .fns = mean,
    na.rm = T
  )) 

```


```{r charpy for micro}
ECA_WT <- read_excel("ECA_PLUS_PRCI.xlsx",
                         sheet = "Wall Thickness")  %>%
  clean_names() %>% 
  filter(str_detect(location_type, "AFG", negate = T)) %>%  #remove post grind wall thick measure
  group_by(group, feature) %>%
  summarize(wt_in = mean(measurement_in, na.rm = T))

ECA_CHARPY <- read_excel("ECA_PLUS_PRCI.xlsx",
                         sheet = "Charpy")  %>%
  clean_names()

ECA_WT_CHARPY <-
  left_join(ECA_WT, ECA_CHARPY,
            by = c("group", 
                   "feature")) %>%
  filter(str_detect(location, "Base")) %>% 
  #removing weld tests
  mutate(
    t_ss_in = charpy_size_mm / 25.4,
    #calc subsize charpy thickness in inches
    CVN_SS = absorbed_energy_ft_lbs,
    #rename subsize CVN
    SA_SS = shear_area_percent / 110, 
    #calc subsize shear area and rename
    #110 to avoid NaN in the transition temperature div by 0
    CVN_US_SS = CVN_SS / (0.9 * SA_SS + 0.1)*.91, 
    #calc subsize CVN upper shelf energy from subsize CVN and subsize shear area
    #Last 0.91 added to renormalize due to 110
    CVN_US_FS = CVN_US_SS * .394 / t_ss_in,
    #calc fullsize CVN upper shelf energy
    sigA = (-21.812) * (charpy_size_mm / 10) ^ 2 + 68.279 * (charpy_size_mm /
                                                               10) + 8.4349,
    #calc sigmoidal parameter A
    sigB = (-12.736) * (charpy_size_mm / 10) ^ 2 + 39.984 * (charpy_size_mm /
                                                               10) + 4.6897,
    #calc sigmoidal parameter B
    TT_SS_F = ifelse(SA_SS == 1, NA,
                           (temperature_f - sigB * log(SA_SS /
                                                        (1 - SA_SS)) + sigA)*.95),
    #calc subsize 85% SA trans temperature
    #Last 0.95 added to renormalize due to 110
    TT_FS_F = TT_SS_F + 66 * (wt_in ^ 0.55) * (t_ss_in ^
                                                             (-.7) - .394 ^ (-.7))
  ) %>% #calc full size transition temp
  group_by(group, feature) %>%
  summarize(
    shear_area_percent = mean(shear_area_percent, na.rm = T),
    CVN_US_FS = mean(CVN_US_FS, na.rm = T),
    TT_FS_F = mean(TT_FS_F, na.rm = T)
  ) 

ECA <-
left_join(ECA_DATA, ECA_WT_CHARPY,
            by = c("group", "feature")) 

ECA <-
  left_join(ECA,ECA_COMPO,
          by = c("group", "feature")) %>% 
  mutate(CVN_US_FS = ifelse(CVN_US_FS > 250 | CVN_US_FS < 10, NA, CVN_US_FS)) %>%
  mutate(CVN_US_FS = ifelse(TT_FS_F > 250 | TT_FS_F < -50, NA, CVN_US_FS)) %>%
  filter(!(is.na(CVN_US_FS)))

```

```{r micro}
ECA_MICRO <- read_excel("Microstructure_Data_Collection_Online_2021_01_05_S5CJ.xlsx",
                    sheet = "Collection2")  %>%
  clean_names() %>%
  filter(sample_type == "Cross_section" | sample_type == "Cross-section",
          str_detect(skip, "NoSkip")) %>%
  group_by(group, feature) %>%
  summarise(across(
    .cols = pct_dark_phase:mean_linear_intercept,
    .fns = mean,
    na.rm = T
  )) %>%
  mutate(pct_dark_phase = ifelse(is.na(pct_dark_phase),0,pct_dark_phase)) %>% 
  rename(DP = pct_dark_phase,
         MLI = mean_linear_intercept) %>% 
  select(group,
         feature,
         DP,
         MLI)

ECA_MICRO <-
  left_join(ECA,ECA_MICRO,
          by = c("group", "feature")) %>%
  select(CVN_US_FS,
         TT_FS_F,
         mn,
         c,
         s,
         si,
         DP,
         MLI
         ) %>% 
  filter(!(is.na(MLI))) %>% 
  mutate(1/sqrt(MLI)) %>% 
  rename(MLI_SQRT_INV = "1/sqrt(MLI)")

```

# Microstructure histograms  

```{r histo CVN, fig.width=7.5}
library(ggplot2)
ggplot(ECA_MICRO, aes(x=CVN_US_FS)) +
  geom_histogram(color="black", binwidth = 20 , fill="steelblue")

```

```{r histo TT, fig.width=7.5}
library(ggplot2)
ggplot(ECA_MICRO, aes(x=TT_FS_F)) +
  geom_histogram(color="black", binwidth = 20 , fill="steelblue")
  

```

# Microstructure effects on CVN and TT  

```{r CVN micro, fig.height = 3.5, fig.width = 7}
 ECA_MICRO %>% 
  pivot_longer(cols = DP:MLI_SQRT_INV) %>%
  ggplot(aes(value, CVN_US_FS, col = name)) +
  geom_point(alpha = 0.5, show.legend = F, size=2) +
  scale_y_log10() +
  facet_wrap(~ name, scales = "free_x") +
  scale_y_continuous(limits = c(0,220))+
  geom_smooth(
    method = "lm",
    se = F,
    show.legend = F,
    col = 'black'
  ) +
  labs(y = "Upper Shelf Energy (Ft-lbs)",
       title = "Microstructure Effects on CVN Upper Shelf Energy",
       subtitle = expression('DP = Dark Phase (%), MLI = Mean Linear Intercept ('*mu* 'm), MLI_SQRT_INV = 1/sqrt(MLI)'))+
  theme_bw(12, "serif")

```

```{r TT micro, fig.height = 3.5, fig.width = 7}
 ECA_MICRO %>% 
  pivot_longer(cols = DP:MLI_SQRT_INV) %>%
  ggplot(aes(value, TT_FS_F, col = name)) +
  geom_point(alpha = 0.5, show.legend = F, size=2) +
  scale_y_log10() +
  facet_wrap(~ name, scales = "free_x") +
  scale_y_continuous(limits = c(0,200))+
  geom_smooth(
    method = "lm",
    se = F,
    show.legend = F,
    col = 'black'
  ) +
  labs(y = expression('Transition Temperature ('*degree* 'F)'),
       title = "Microstructure Effects on Transition Temperature",
       subtitle = expression('DP = Dark Phase (%), MLI = Mean Linear Intercept ('*mu* 'm), MLI_SQRT_INV = 1/sqrt(MLI)'))+
  theme_bw(12, "serif")

```

# CVN lm for s + si + DP  

```{r cvn lm micro}
cvn_lm_micro <-
  lm(log(CVN_US_FS) ~  s + si + DP , data = ECA_MICRO)

summary(cvn_lm_micro)
```

```{r cvn lm micro plot}

bind_cols(truth = exp(cvn_lm_micro$model$`log(CVN_US_FS)`),
          pred = exp(cvn_lm_micro$fitted.values)) %>%
  ggplot(aes(pred, truth)) +
  geom_point(alpha = 0.5, size = 2, col = 'red') +
  coord_obs_pred() +
  geom_abline(lty = 3, col = 'grey50', lwd = 1.2) +
  theme_bw(14, "serif") +
  labs(
    title = "CVN Upper Shelf Energy (Ft-lbs)",
    subtitle = "Linear Model based on Dark Phase, S, & Si",
    x = 'Predicted',
    y = 'Observed')
```

# TT lm for mn, MLI and DP  

```{r tt lm micro}
tt_lm_micro <-
  lm(log(TT_FS_F) ~  mn + MLI_SQRT_INV + DP , data = ECA_MICRO)

summary(tt_lm_micro)
```

```{r tt lm micro plot}
bind_cols(truth = exp(tt_lm_micro$model$`log(TT_FS_F)`),
          pred = exp(tt_lm_micro$fitted.values)) %>%
  ggplot(aes(pred, truth)) +
  geom_point(alpha = 0.5, size = 2, col = 'red') +
  coord_obs_pred() +
  geom_abline(lty = 3, col = 'grey50', lwd = 1.2) +
  theme_bw(14, "serif") +
  labs(
    title = expression('Transition Temperature ('*degree*'F)'),
    subtitle = "Linear Model based on Mn, Dark Phase, and 1/sqrt(MLI)",
    x = 'Predicted',
    y = 'Observed')
```

# CVN microstructure importance compared to elements  

```{r rand forest specs for micro}
rf_spec <- rand_forest(
  mode = "regression",
  trees = 1000,
  mtry = 2,
  min_n = 3
) %>%
  set_engine("ranger",
             importance = "impurity" ,
             num.threads = 6)
```


```{r cvn micro element importance}
rf_fit_cvn <- rf_spec %>%
  fit(CVN_US_FS ~ mn + c + s + si + DP + MLI , data = ECA_MICRO)

results_cvn = rf_fit_cvn %>%
  predict(new_data = ECA_MICRO) %>%
  mutate(truth = ECA_MICRO$CVN_US_FS, model = "RF")

results_cvn %>% 
  metrics(truth, .pred) %>% gt()

import_cvn <- tibble(
  imp = rf_fit_cvn$fit$variable.importance,
  element = names(rf_fit_cvn$fit$variable.importance)
)

ggplot(import_cvn,
       aes(x = reorder(element, -imp),
           imp)) +
  geom_col(width = 0.25,
           fill = 'steelblue') +
  labs(title = "Variable Importance for CVN Upper Shelf Energy",
       x = "Model Variable",
       y = "Importance") +
  theme_bw(16, "serif")
```

# TT microstructure importance compared to elements  

```{r tt micro element importance}
rf_fit_tt <- rf_spec %>%
  fit(TT_FS_F ~ mn + c + s + si + DP + MLI , data = ECA_MICRO)

results_tt = rf_fit_tt %>%
  predict(new_data = ECA_MICRO) %>%
  mutate(truth = ECA_MICRO$TT_FS_F, model = "RF")

results_tt %>% 
  metrics(truth, .pred) %>% gt()

import_tt <- tibble(
  imp = rf_fit_tt$fit$variable.importance,
  element = names(rf_fit_tt$fit$variable.importance)
)

ggplot(import_tt,
       aes(x = reorder(element, -imp),
           imp)) +
  geom_col(width = 0.25,
           fill = 'steelblue') +
  labs(title = "Variable Importance for Transition Temperature",
       x = "Model Variable",
       y = "Importance") +
  theme_bw(16, "serif")
```


