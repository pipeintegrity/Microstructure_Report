---
title: "Microstructure Report for Rabbit Springs (Draft)"
author: "Nathan Switzner and Joel Anderson"
date: "`r format(Sys.time(), '%B %d, %Y')`"
output: 
  word_document
always_allow_html: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning=FALSE, message=FALSE)
```

```{r libraries and data}
# load libraries ----------------------------------------------------------
library("gridExtra")                        # Load gridExtra package
library(janitor)
library(patchwork)
library(tidyverse)
library(readxl)
library(lubridate)
library(patchwork)
# library(DataCombine)
library(tidymodels)
library(patchwork)
# library(rstanarm)
library(kableExtra)
library(flextable)
theme_set(theme_bw(16)) #set theme to save typing
```

```{r custom plot function}
tp_plot <- function(df, x, y) {
  ggplot(df, aes(x={{x}}, y={{y}})) +
    geom_point(alpha = 0.6,
               col = 'midnightblue',
               size = 2) +
    geom_abline(col = 'grey50', 
                lty = 3, 
                lwd = 1.2) +
    tune::coord_obs_pred() +
    geom_smooth(method = "lm", se=F)+
    theme_bw(16, "serif")
}

```

```{r ECA feature information data import}
# Composition ------------------------------------------------------------

eca_comp <-
  read_excel("MasterDB-SQL-2021-07-28 NS.xlsx",
             sheet = "Composition") %>%
   janitor::clean_names() %>%
  filter(skip==FALSE,
         tool== "AA/LECO (C&S)-Filings") %>%
     mutate(across(.cols = c:ca, ~ ifelse(str_detect(string = .x, pattern = "<"),
        as.numeric(str_remove(string =.x, pattern =  "<"))/ 4,
    as.numeric(.x)))) %>% 
  filter(
   ni < .5 | is.na(ni),
    cu < 1 | is.na(cu),
    ti < 1 | is.na(ti),
    cr < .3 | is.na(cr),
    al < 1 | is.na(al),
    c < 0.4 | c > 0.03 | is.na(c),
    si < 0.35 | is.na(si),
    mn < 3| is.na(mn),
    mo < 0.1 | is.na(mo)
  ) %>%
  mutate(
    c = ifelse(c > 0.4 | c < .03, NA, c),
    mn = ifelse(mn > 2 | mn < .2, NA, mn),
    p = ifelse(p > 0.16 | p < 0.001, NA, p),
    s = ifelse(s > 0.08 | s < 0.001, NA, s),
    si = ifelse(si > 0.5 | si < 0.005, NA, si),
    nb = ifelse(nb > 0.15 | nb < 0.0001, NA, nb),
    v = ifelse(v > 0.15 | v < 0.0001, NA, v),
    ti = ifelse(ti > 0.15 | ti < 0.0001, NA, ti),
    ni = ifelse(ni > 0.3 | ni < 0.0001, NA, ni),
    cu = ifelse(cu > 0.5 | cu < 0.0001, NA, cu),
    mo = ifelse(mo > 0.15 | mo < 0.0001, NA, mo),
    cr = ifelse(cr > 0.3 | cr < 0.0001, NA, cr),
    b = ifelse(b > 0.001 | b < 0.00001, NA, b),
    ca = ifelse(ca > 0.01 | ca < 0.00001, NA, ca)
  )  %>% 
  group_by(group, feature) %>%
  summarise(across(
    .cols = c:ca,
    .fns = mean,
    na.rm = T
  )) %>%
  select(group,
         feature,
         al,
        c,
        cr,
        cu,
        mn,
        mo,
        nb,
        ni,
        p,
        s,
        si,
        v)

# Feature data -----------------------------------------------------------

eca_feature <-
  read_excel("MasterDB-SQL-2021-07-28 NS.xlsx",
             sheet = "Features") %>%
  janitor::clean_names() %>%
  rename(
    OD = od_inch,
    wall = recorded_nominal_wt_inch,
    feature = feature_id,
    year = pg_e_install_year
  ) %>%
  mutate(
    mfr_year = (str_sub(mfr_year, 1, end = 4)),
    mfr_year = ifelse(mfr_year == "earl", 1952, mfr_year),
    group = ifelse(group == "ARB Houston", "ATS-ARBH", group),
    grade = case_when(
      group == "Modesto Yard" & feature == "Feature 6" ~ "NA",
      group == "Modesto Yard" & feature == "Feature 8" ~ "NA",
      group == "Modesto Yard" & feature == "Feature 15" ~ "NA",
      group == "Modesto Yard" & feature == "Feature 16" ~ "NA",
      group == "Modesto Yard" & feature == "Feature 17" ~ "NA",
      group == "Modesto Yard" & feature == "Feature 18" ~ "NA",
      group == "Modesto Yard" & feature == "Feature 19" ~ "NA",
      TRUE ~ grade
    ),
    year = case_when(
      str_detect(string = year, pattern = "/") ~ str_sub(year,-4),
      group == "Modesto Yard" & feature == "Feature 6" ~ "NA",
      group == "Modesto Yard" & feature == "Feature 8" ~ "NA",
      group == "Modesto Yard" & feature == "Feature 15" ~ "NA",
      group == "Modesto Yard" & feature == "Feature 16" ~ "NA",
      group == "Modesto Yard" & feature == "Feature 17" ~ "NA",
      group == "Modesto Yard" & feature == "Feature 18" ~ "NA",
      group == "Modesto Yard" & feature == "Feature 19" ~ "NA",
      is.na(year) ~ mfr_year,
      TRUE ~ year
    ),
    year = as.numeric(year),
    OD = as.numeric(OD),
    wall = as.numeric(wall),
    grade = case_when(
      str_detect(grade, "35000") ~ "Grade B",
      str_detect(grade, "B") ~ "Grade B",
      str_detect(grade, "X42") ~ "X42",
      str_detect(grade, "A-53") ~ "Grade B",
      grade == "30000" ~ "Early",
      grade == "40000" ~ "X42",
      grade == "X-60" ~ "X60",
      grade == "X-48" ~ "X46",
      str_detect(grade, "48") ~ "X46",
      str_detect(grade, "65") ~ "X65",
      grade == "GR B" ~ "Grade B",
      grade == "Unknown" ~ "NA",
      grade == "N/A" ~ "NA",
      grade == "B/Unknown" ~ "Grade B",
      TRUE ~ grade
    ),
    grade = str_remove(grade, "API 5L "),
    grade = str_remove(grade, "-"),
    grade = ifelse(grade == "NA", NA, grade),
    source = "ECA2"
  ) %>%
  filter(feature_type == "Pipe")

# IIT data ----------------------------------------------------------------

eca_ndt <-
 read_excel("MasterDB-SQL-2021-07-28 NS.xlsx",
             sheet = "NDT") %>%
  janitor::clean_names() %>%
  rename(group = group_name) %>%
  filter(
    skip == FALSE,
    group != "Calibration Blocks",
    str_detect(
      "Old",
      negate = T,
      vendor_test_area_label),
      reader_method == "DPT",
      vendor %in% c('ATS', 'TDW')
    ) %>%
      group_by(group, feature) %>%
      summarise(
        iitys_5 = mean(x0_5_percent_eul_ys_ksi, na.rm = T),
        iituts = mean(uts_ksi, na.rm = T),
        nsamples = n()
      ) 
# %>%
#       filter(nsamples >= 10
#       )


# Tensile data ------------------------------------------------------------

eca_tensile <-
read_excel("MasterDB-SQL-2021-07-28 NS.xlsx",
             sheet = "Tensile") %>%
  janitor::clean_names() %>%
  filter(skip == FALSE ,
         type != "Weld" ,
         type != "GirthWeldStrip" ,
         group != "Calibration Blocks") %>%
  rename(ys5 = x0_5_percent_eul_ys_ksi,
         uts = uts_ksi,
         ten_n = n
         ) %>%
  group_by(group, feature) %>%
  summarise(ten_ys = mean(ys5, na.rm = T),
            ten_uts = mean(uts, na.rm = T),
            ten_n = mean(ten_n, na.rm = T))

# Wall Thickness -----------------------------------------------------

eca_wt <- read_excel("MasterDB-SQL-2021-07-28 NS.xlsx",
                     sheet = "Wall Thickness")  %>%
  clean_names() %>%
  filter(str_detect(location_type, "AFG", negate = T)) %>%  #remove wall thickness measures after grind (AFG)
  group_by(group, feature) %>%
  summarize(wt_in = mean(measurement_in, na.rm = T))  #%>%

## Charpy data ----------------------------------------------------------       

eca_cvn <- read_excel("MasterDB-SQL-2021-07-28 NS.xlsx",
                         sheet = "Charpy")  %>%
  clean_names() %>% 
  full_join(eca_wt, by= c("group", "feature")) %>% 
  filter(str_detect(location, "Base")) %>% #removing weld tests
  mutate(
    SA_SS = ifelse(shear_area_percent==100, 0.99,shear_area_percent/ 100),
    #calc subsize shear area with 0.99 to avoid singularities and rename
    t_ss_mm = charpy_size_mm,
    #rename subsize charpy thickness in mm
    t_ss_in = t_ss_mm / 25.4,
    #calc subsize charpy thickness in inches
    sigA = (-29.3943) * (t_ss_mm / 10) ^ 2 + 72.9619 * (t_ss_mm / 10) +
      6.2530,
    #calc sigmoidal parameter A per API 579 table on page 9F-3
    sigB = (76.0070) * (t_ss_mm / 10) ^ 3 + 
      (-183.4809) * (t_ss_mm / 10) ^ 2 +
      148.2843 * (t_ss_mm / 10) - 7.8121,
    #calc sigmoidal parameter B per API 579 table on page 9F-3
    TT_SS_F =  temperature_f - sigB * log(SA_SS / (1 - SA_SS)) + sigA,
    #calc subsize transition temp
    #previously a 0.99 was added at the end to correct
    TT_FS_F = TT_SS_F + 66 * (wt_in ^ 0.55) * (t_ss_in ^ (-.7) - 0.394 ^ (-.7)),
    #calc fullsize (0.394 in size) transition temp using the nominal wall thickness
    CVN_SS = absorbed_energy_ft_lbs,
    #rename subsize CVN
    CVN_US_SS = CVN_SS / (0.9 * SA_SS + 0.1),
    #calc subsize CVN upper shelf energy from subsize CVN and subsize shear area
    CVN_US_FS = CVN_US_SS * 0.394 / t_ss_in
    #calc fullsize CVN upper shelf energy
  ) %>%
  group_by(group, feature) %>%
  summarize(
    CVN_US_FS = mean(CVN_US_FS, na.rm = T),
    TT_FS_F = mean(TT_FS_F, na.rm = T)
  ) %>%
  select("group", "feature", "CVN_US_FS", "TT_FS_F")
#-------------------------------------------------------------------------

eca_micro <-
  read_excel("Microstructure_Data_Collection_Online_2021_01_05_S5CJ.xlsx",
             sheet = "Collection2") %>%
  rename(
    polygonal = `Polygonal ferrite grains that are relatively distinct and free of dots, lines or cloudy features.`) %>%
  clean_names() %>% 
  mutate(
    sample_type = str_replace(sample_type, "-", "_"),
    group_feature = paste0(group, " ", feature),
    year = year(evaluation_date),
    path = str_remove(string = path, pattern = ".jpg"),
    path = str_remove(string = path, pattern = ".tif")
  ) %>%
  filter(sample_type == "Replica") %>% 
  group_by(group, 
           feature,
           sample_type
           ) %>%
  summarise(
    astm_grain_size = mean(astm_grain_size, na.rm = T),
    mean_linear_intercept = mean(mean_linear_intercept, na.rm = T),
    pct_dark_phase = mean(pct_dark_phase, na.rm = T),
    ) %>%
  ungroup()

## Join the data -----------------------------------------------------
eca_all <- eca_ndt %>%
  full_join(eca_feature,
            by = c("group", "feature")) %>%
  full_join(eca_comp,
            by = c("group", "feature")) %>%
  full_join(eca_tensile,
            by = c("group", "feature")) %>%
  full_join(eca_cvn, 
            by = c("group", "feature")) %>%
  full_join(eca_wt, 
            by = c("group", "feature")) %>%
  full_join(eca_micro, 
            by = c("group", "feature")) 

eca_all_micro_complete <- as.data.frame(eca_all[complete.cases(eca_all[ , "astm_grain_size"]),]) 

```

# Executive Summary  

RSI-Pipeline Solutions was requested by Pacific Gas and Electric's (PG&E) Facilities Integrity Management Program (FIMP) to analyze images from six microstructural replicas (one per feature) from the Rabbit Springs facility. The objective was to quantify and characterize the microstructures to determine whether they were consistent with the reported vintage. Secondly, the microstructures were used to qualitatively assess the expected feature toughness properties.

Firstly, the feature microstructures did not appear inconsistent with expectations for the reported vintages of 1980 and 1991. Secondly, based on the assessments of grain size and dark phase, the upper shelf absorbed energy and ductile to brittle transition temperature appeared moderate (likely to be neither extremely tough nor extremely brittle).

# Feature Information   

The relevant background information for the features of interest are listed Table 1. This information is useful for general knowledge as-well-as ruling out impossible groupings based on differences in feature type, seam type, outside diameter (OD), and wall thickness (WT).

```{r station feature table prep}

## Join the station data -----------------------------------------------------
station_feature_wt_ndt <- eca_all %>%
    filter(group == "Rabbit Springs",
        feature %in% c("JT-51", "JT-62.5", "JT-74.5", "JT-77.4", "JT-127", "JT-138.5")) %>% 
  select(
    group,
    feature,
    feature_type,
    seam_type,
    year,
    OD,
    wt_in)

flextable(station_feature_wt_ndt[1:6,-1]) %>% 
  set_caption("Table 1 Feature Information.") %>% 
  set_formatter(year = function(x) sprintf("%.00f", x),
                OD = function(x) sprintf("%.01f", x),
                wt_in = function(x) sprintf("%.03f", x),
                iitys_5 = function(x) sprintf("%.01f", x),
                iituts = function(x) sprintf("%.01f", x)) %>%
  set_header_labels(values = list(feature = 'Feature',
                                  feature_type = "Type",
                                  seam_type = "Seam Type",
                                  year = "Year",
                                  OD = "OD (in)",
                                  wt_in = "WT (in)")) %>% 
  align(j = -1, align = "center", part = "all") %>% 
  autofit()
```

# Compositional Data from Filings

The compositional elements, carbon (C), manganese (Mn), sulfur (S), and silicon (Si) are important in steelmaking and are also generally reliable elements for identification of possible groups of pipe, when estimated using filings removed from the pipe surface. The following table provides the filings analysis for C, Mn, S, and Si. For this station, features JT-51, JT-62.5, JT-127, and JT-138.5 had essentially similar compositions, but features JT-74.5 and JT-77.4 differed significantly in terms of Si, Mn, and S content.

```{r station comp}

## Join the station data -----------------------------------------------------
station_feature_wt_ndt <- eca_all %>%
    filter(group == "Rabbit Springs",
        feature %in% c("JT-51", "JT-62.5", "JT-74.5", "JT-77.4", "JT-127", "JT-138.5")) %>% 
  select(
    group,
    feature,
    c,
    mn,
    si,
    s
  )

flextable(station_feature_wt_ndt[1:6,-1]) %>% 
  set_caption("Table 2 Filings Composition") %>% 
  set_formatter(c = function(x) sprintf("%.02f", x),
                mn = function(x) sprintf("%.02f", x),
                si = function(x) sprintf("%.02f", x),
                s = function(x) sprintf("%.03f", x)) %>% 
  set_header_labels(values = list(feature = 'Feature',
                                  c = "C (wt%)",
                                  mn = "Mn (wt%)",
                                  si = "Si (wt%)",
                                  s = "S (wt%)")) %>% 
  align(j = -1, align = "center", part = "all") %>% 
  autofit()

```

# Microstructure Images 

The microstructures that were analyzed are shown below. Both an in-situ image and an image taken in with a laboratory microscope of a field replica are shown. Typically the in-situ images are not used for quantitative evaluation. However, due to the use of silicone "Repliset" replication media, the replicates did not adequately replicate the details of the grain boundaries and dark phase. The poor resolution and lack of important features made the quantitative evaluation difficult. 

For the in-situ images, the circular viewing area was determined to be 465 μm in diameter. This scale is based on images taken by the vendor of a calibrated reference slide and is important for grain size estimation. The replica images had a printed scale bar, which was useful for grain size estimation, however the replica images did not have distinct grain boundaries due to the use of silicone replication medium.

All images apparently exhibit a light phase and a dark phase, which indicate ferrite and pearlite constituents, respectively. For features JT-127, JT-138.5, JT-51, and JT-62.5, the pearlite appears somewhat unclear or degenerated. There may be a number of reasons for the lack of clarity, but one possibility is a long hold time at a temperature below 700 °C (~1300 °F), which allows redistribution of the carbon. Decarburization of the surface is another possibility. Features JT-74.5 and JT-77.4 exhibited more clarity of the grain boundaries and dark phase (pearlite constituent). Visually, the microstructures for all six features meet expectations for the surface microstructure of hot rolled or normalized steel linepipe.


![](RabbitSprings/_JT127_Field.jpg){height=250px} ![](RabbitSprings/_JT127_Replica.jpg){height=250px}  
Feature JT-127 micrographs: in-situ (left) and replica (right).  
   
![](RabbitSprings/_JT138.5_Field.jpg){height=250px} ![](RabbitSprings/_JT138.5_Replica.jpg){height=250px}  
Feature JT-138.5 micrographs: in-situ (left) and replica (right).  
  
![](RabbitSprings/_JT51_Field.jpg){height=250px} ![](RabbitSprings/_JT51_Replica.jpg){height=250px}  
Feature JT-51 micrographs: in-situ (left) and replica (right).  
  
![](RabbitSprings/_JT62.5_Field.jpg){height=250px} ![](RabbitSprings/_JT62.5_Replica.jpg){height=250px}  
Feature JT-62.5 micrographs: in-situ (left) and replica (right).  
  
![](RabbitSprings/_JT74.5_Field.jpg){height=250px} ![](RabbitSprings/_JT74.5_Replica.jpg){height=250px}  
Feature JT-74.5 micrographs: in-situ (left) and replica (right).  
  
![](RabbitSprings/_JT77.4_Field.jpg){height=250px} ![](RabbitSprings/_JT77.4_Replica.jpg){height=250px}  
Feature JT-77.4 micrographs: in-situ (left) and replica (right).  
  
# Quantitative Evaluations  

For the remainder of this analysis, features JT-51, JT-62.5, JT-127, and JT-138.5 were grouped together based on similarities in the microstructure as-well-as feature type, seam type, OD, WT, carbon, sulfur, manganese, and silicon content. Due to the use of silicone "Repliset" replication media, the replicates did not adequately replicate the details of the grain boundaries and dark phase. The poor resolution and lack of important features made the quantitative evaluation difficult. The quantitative results should be viewed as estimates. Quantification was performed by one subject matter expert using the ASTM E112 comparison method for grain size estimation and the PG&E/RSI-PS developed comparison method for dark phase estimation, which are described in detail in Appendix 1. The in-situ images were used for quantification, and the replica images were used for reference.

The results of the quantitative evaluations of grain size (ASTM) and dark phase (%) for the features are provided in Table 3. Per ASTM E112, the repeatability and reproducibility of comparison ratings for grain size are generally ±1 grain size number. The repeatability and reproducibility of the comparison ratings for dark phase are not yet known, but a reasonable estimate is ±20% of the value.

```{r station_micro data table}
# Station microstructure data import from the Excel evaluation worksheet
# In the Excel evaluation worksheet I created an additional row for the averages of the features that are too similar to distinguish: JT-127/138.5/51/62.5/127

station_micro <- read_excel("Microstructure_Evaluation_Worksheet_2020_08_20_Rabbit_Springs.xlsm",
                      sheet = "4)Values") %>%
  janitor::clean_names() %>%
  mutate(
    sample_type = str_replace(sample_type, "-", "_"),
    group_feature = paste0(group, " ", feature),
    year = year(date_of_evaluation),
    path = str_remove(string = path, pattern = ".jpg"),
    path = str_remove(string = path, pattern = ".tif"),
    pct_dark_phase = percent_dark_phase
  ) %>%
  select(
    group,
    feature,
    alternate_id,
    polygonal_or_irregular,
    method,
    pct_dark_phase,
    astm_grain_size,
    mean_linear_intercept
  ) %>% 
  group_by(group, feature, alternate_id) %>% 
  summarize(pct_dark_phase = round(mean(pct_dark_phase, na.rm = TRUE),1),
            astm_grain_size = round(mean(astm_grain_size, na.rm = TRUE),1),
            mean_linear_intercept = round(mean(mean_linear_intercept, na.rm = TRUE),1)) %>% 
  ungroup() 

station_micro_group <- station_micro %>% 
  filter(group == "Rabbit Springs",
        feature %in% c("JT-74.5", "JT-77.4", "JT-51/62.5/127/138.5")) %>% 
  select(
    group,
    feature,
    astm_grain_size,
    pct_dark_phase
  )

flextable(station_micro_group[1:3,-1]) %>% 
  set_caption("Table 3 Quantitative Evaluation Results.") %>% 
  set_formatter(astm_grain_size = function(x) sprintf("%.01f", x),
                pct_dark_phase = function(x) sprintf("%.00f", x)) %>% 
  set_header_labels(values = list(feature = 'Feature',
                                  astm_grain_size = "ASTM Grain Size",
                                  pct_dark_phase = "Dark Phase (%)"
                                  )) %>% 
  align(j = -1, align = "center", part = "all") %>% 
  autofit()

```


# Vintage Correlation  

The microstructure evaluation results for the features from Rabbit Springs were overlaid with the trends identified from the validation data set as shown in the following plot. The grayscale points represent the data from the features from the validation dataset. The shaded regions represent the expected range of grain size and dark phase from the station features with the vertical dotted line indicating the nominal value. 

The validation dataset includes quantitative evaluations of grain size and dark phase percent by more than five trained evaluators. There were typically one to two images evaluated per feature. Two methods were used for each grain size analysis, counting and comparison methods. The counting and comparison methods for grain size are based on the ASTM E112 Jeffries planimetric method and comparison method, respectively. Two methods were also used for each dark phase analysis, counting and comparison methods. The counting method for dark phase estimation is based on ASTM E562, and the comparison method for dark phase estimation was developed by PG&E.

The features exhibited a grain size in the range of 9-12, which can be observed for steels of a wide range of vintages. Feature JT-77.4 appeared to exhibit a finer grain size, which could indicate that it is more modern than the other features. The amount of dark phase in the features from Rabbit Springs apparently could be exhibited by line pipe for a variety of vintages from ~1930 to present day, depending on the grade. 

```{r addition of gs and dp min and max for the plot rectangles}
station_micro_plots <- station_micro_group %>% 
  mutate(
    gs_min = astm_grain_size - 1,
    gs_max = astm_grain_size + 1,
    dp_min = pct_dark_phase - pct_dark_phase * .2,
    dp_max = pct_dark_phase + pct_dark_phase * .2)
```

```{r GS DP and Vintage, fig.height=3, fig.width=8.5}

plot1 <- ggplot() +
  geom_rect(
    data = station_micro_plots,
    aes(
      xmin = gs_min,
      xmax = gs_max,
      ymin = c(1925, 1928, 1931),
      ymax = c(2024, 2018, 2021),
      fill = feature
    ),
    alpha = 0.2,
    show.legend = FALSE
  ) +
  geom_point(data = eca_all_micro_complete, aes(astm_grain_size, year), alpha=0.4) +
  geom_vline(
    data = station_micro_plots,
    aes(xintercept = astm_grain_size, col = feature),
    lty = 2,
    show.legend = FALSE
  ) +
  scale_y_continuous(breaks = seq(1940, 2020, by = 20)) +
  scale_x_continuous(breaks = seq(8, 14, by = 1))+
  ylab("Year") + 
  xlab("ASTM Grain Size")
 

plot2 <- ggplot() +
  geom_rect(
    data = station_micro_plots,
    aes(
      xmin = dp_min,
      xmax = dp_max,
      ymin = c(1925, 1928, 1931),
      ymax = c(2024, 2018, 2021),
      fill = feature
    ),
    alpha = 0.2,
    show.legend = FALSE
  ) +
  geom_point(data = eca_all_micro_complete, aes(pct_dark_phase, year), alpha=0.4) +
  geom_vline(
    data = station_micro_plots,
    aes(xintercept = pct_dark_phase, col = feature),
    lty = 2
  ) +
  scale_y_continuous(breaks = seq(1940, 2020, by = 20))+
  ylab("Year") + 
  xlab("Dark Phase (%)")

plot1 + plot2

```

# CVN Upper Shelf Energy Correlation  

The Charpy V-Notch (CVN) test is a dynamic mechanical test wherein a standard notched sample of steel plate or linepipe wall is fractured by a rapidly moving hammer. The measure of energy absorbed from this test, especially in the upper shelf region is useful for comparison with pipe burst pressures.

The Rabbit Springs features, with grain sizes in the range of 9-12 appear to be in a transition region when it comes to CVN upper shelf absorbed energy. Below ASTM 9.5, all steels in the validation set exhibited an upper shelf energy less than 65 ft-lbs. Above ASTM 11.5, all steels in the validation set exhibited an upper shelf energy of more than 100 ft-lbs. 

The dark phase results also lead to the expectation that these steels could exhibit CVN upper shelf energies of 25-100 ft-lbs. Again, feature JT-77.4 appeared to exhibit a finer grain size and less dark phase, which could indicate higher toughness than the other features.

```{r GS, DP, and Charpy, fig.height=3, fig.width=8.5}

plot1 <- ggplot() +
  geom_rect(
    data = station_micro_plots,
    aes(
      xmin = gs_min,
      xmax = gs_max,
      ymin = c(8, 4, 12),
      ymax = c(300, 280, 320),
      fill = feature
    ),
    alpha = 0.2,
    show.legend = FALSE
  ) +
  geom_point(data = eca_all_micro_complete, aes(astm_grain_size, CVN_US_FS), alpha=0.4) +
  geom_vline(
    data = station_micro_plots,
    aes(xintercept = astm_grain_size, col = feature),
    lty = 2,
    show.legend = FALSE
  ) +
  ylab("CVN Upper Shelf (ft-lbs)") + 
  xlab("ASTM Grain Size")

plot2 <- ggplot() +
  geom_rect(
    data = station_micro_plots,
    aes(
      xmin = dp_min,
      xmax = dp_max,
      ymin = c(5, 10, 15),
      ymax = c(280, 300, 320),
      fill = feature
    ),
    alpha = 0.2,
    show.legend = FALSE
  ) +
  geom_point(data = eca_all_micro_complete, aes(pct_dark_phase, CVN_US_FS), alpha=0.4) +
  geom_vline(
    data = station_micro_plots,
    aes(xintercept = pct_dark_phase, col = feature),
    lty = 2
  ) +
  ylab("CVN Upper Shelf (ft-lbs)") + 
  xlab("Dark Phase (%)")

plot1 + plot2

```


# CVN Transition Temperature Correlation  

The CVN 85% shear appearance transition temperature (SATT) is a useful indicator of whether brittle or ductile fracture behavior can be expected in the field. Often the SATT is used to evaluate whether the steel is at or near the toughness expected from upper shelf behavior. Note, however, that the transition temperatures from CVN testing do not directly correspond to transition temperatures for slow crack growth in a line pipe. It is possible for linepipe to exhibit ductile behavior at temperatures 100-200 °F less than the CVN 85% SATT. A strong correlation between grain size and SATT has been observed as shown in the following figure. Fine grains (large ASTM numbers) result in low SATT, indicating ductile fracture over a wide temperature range. Large grains (small ASTM numbers) result in a high SATT, possibly increasing the risk of brittle fracture and failure at temperatures relevant to typical working temperatures. 

The grain sizes for the Rabbit Spring features fall in about the middle of the apparently linear correlation with SATT. The dark phase plot does not add too much additional insight except to decrease the expectation of an extremely low SATT. Based on these plots, the SATT for the features could be in the range of about 20-150 °F. Again, feature JT-77.4 appeared to exhibit a finer grain size and less dark phase, which could be more likely to lead to ductile behavior at lower temperatures than the other features. These features are not likely to be on the extremely brittle end (high SATT), which would be more likely if the grain size was less than ASTM 9.

```{r GS DP and Charpy V Notch Transition Temperature, fig.height=3, fig.width=8.5}

plot1 <- ggplot() +
  geom_rect(
    data = station_micro_plots,
    aes(
      xmin = gs_min,
      xmax = gs_max,
      ymin = c(-140, -130, -150),
      ymax = c(170, 180, 160),
      fill = feature
    ),
    alpha = 0.2,
    show.legend = FALSE
  ) +
  geom_point(data = eca_all_micro_complete, aes(astm_grain_size, TT_FS_F), alpha=0.4) +
  geom_vline(
    data = station_micro_plots,
    aes(xintercept = astm_grain_size, col = feature),
    lty = 2,
    show.legend = FALSE
  ) +
  ylab("CVN SATT (°F)") + 
  xlab("ASTM Grain Size")

plot2 <- ggplot() +
  geom_rect(
    data = station_micro_plots,
    aes(
      xmin = dp_min,
      xmax = dp_max,
      ymin = c(-150, -140, -130),
      ymax = c(160, 170, 180),
      fill = feature
    ),
    alpha = 0.2,
    show.legend = FALSE
  ) +
  geom_point(data = eca_all_micro_complete, aes(pct_dark_phase, TT_FS_F), alpha=0.4) +
  geom_vline(
    data = station_micro_plots,
    aes(xintercept = pct_dark_phase, col = feature),
    lty = 2
  ) +
  ylab("CVN SATT (°F)") + 
  xlab("Dark Phase (%)") 

plot1 + plot2
```

# Appendix 1: Quantitative Evaluation Methods 

## Grain Size  

Grain size was quantified using the ASTM E112 comparison method using a tool built into a Microsoft Excel document. In this method the sample grain structure was compared to a series of images of known grain size, and the image with grain size most closely matching the ferrite (light phase) grain size of the sample was selected. Per ASTM the repeatability and reproducibility of comparison chart ratings are generally ±1 grain size number. The comparison method is a rapid technique, requiring only about one minute per sample.

Selected images may also be quantified using the ASTM E112 Jeffries planimetric method, which is referred to herein as the "counting" method. In this method the number of grains in a known area are counted. The number of grains per unit area, NA , is used to determine the ASTM grain size number, G. Per ASTM, the precision of the method is about ±0.25 ASTM grain size units, and the repeatability and reproducibility are less than ±0.5 grain size units. The counting method is slower than the comparison method, requiring about 5-10 minutes depending on the microstructure and evaluator skill. Typically, for a 400X or 500X image, the counting method becomes quite difficult for grain sizes less than \~5 μm.

There are two dimensions used frequently for describing grain size: (1) ASTM grain size (GS) and (2) mean linear intercept (MLI) GS. The advantage of MLI GS is that it relates to a physical dimension in the microstructure (mean distance between grain intersections for random lines drawn on the 2-dimensional cross-section of the microstructure) and is reported herein in units of micrometers (μm). On the other hand, the ASTM GS sometimes enables better comparison of the standard deviation from large grain sizes to small grain sizes. Thus we will provide here the formulae to convert between MLI and ASTM GS as desired.

ASTM E112 defines grain size number, G as $N_{AE}=2^{G-1}$ where $N_{AE}$ is the number of grains per square inch at 100X magnification. To obtain the number per square millimeter at 1X, multiply by 15.50. For relating ASTM grain size number, G, to mean linear intercept, L, ASTM E112 defines G such that G=0 when L=320 μm. Thus, $G=10-2*LOG_2(L/10)$ and $L=320*2^{-G/2}$ for L in micrometers (μm).

## Dark Phase  

Dark phase was quantified using a comparison method developed by PG&E and Exponent. First, the amount of dark phase in several microstructures at several magnifications was quantified using image analysis and the ASTM E562 point counting method. Then, these images were incorporated into a tool built into a Microsoft Excel document for comparison with sample microstructures. The comparison microstructure with the amount of dark phase that most closely matches the sample is chosen at first. Then, interpolation is performed to increase the resolution for the amount of dark phase, depending on whether the sample appears to have more or less dark phase than the comparison micrograph.


```{r GS, DP, and Vintage, fig.height=3, fig.width=8.5}


# Appendix 2: Other Reference Plots

# plot of year vs silicon and sulfur in appendix with the Rabbit Springs data overlaid

# plot1 <- ggplot() +
#   geom_point(data = eca_all, aes(si, year), alpha=0.4) +
#   geom_vline(
#     data = station_feature_wt_ndt,
#     aes(xintercept = jitter(si, 10), col = feature),
#     lty = 2,
#     show.legend = FALSE
#   )  +
#   scale_y_continuous(breaks = seq(1940, 2020, by = 20)) 
# 
# plot2 <- ggplot() +
#   geom_point(data = eca_all, aes(s, year), alpha=0.4) +
#   geom_vline(
#     data = station_feature_wt_ndt,
#     aes(xintercept = jitter(s, 6), col = feature),
#     lty = 2
#   ) +
#   scale_y_continuous(breaks = seq(1940, 2020, by = 20))
# 
# 
# plot1 + plot2

```


```{r pearlite}

# The amount of equilibrium pearlite (previously called "dark phase") can be predicted using the iron + carbide equilibrium phase diagram. Based on the well-known "lever rule", if the carbon content is known, then the equilibrium pearlite content, P (%), for an binary iron-carbon alloy should be:
# 
# $$P=(C - .022)/(C_E - .022)*100$$ where $C$ is the carbon content in wt% and $C_E$ represents the equilibrium eutectoid carbon concentration in wt%. When alloying elements such as Mn and Si are introduced, the equilibrium eutectod carbon concentration tends to shift, and can be estimated by the following expression relevant to the pipeline steels: $$C_E = 0.76 -0.075 * Mn - 0.1 * Si$$ where $Mn$ and $Si$ are the Mn and Si content in wt%. Based on these simple expressions, the expected equilibrium pearlite content is provided in the following table along with the metallographically estimated dark phase content. With equilibrium processing conditions, on average, the dark phase and equilibrium pearlite content would be expected to be similar.
# 
# station_comp_group1 <- station_feature_wt_ndt %>% 
#   filter(group == "Rabbit Springs",
#         feature %in% c("JT-51", "JT-62.5", "JT-127", "JT-138.5")) %>%
#   summarize(c = mean(c),
#             mn = mean(mn),
#             si = mean(si)) %>% 
#   mutate(feature = "JT-51/62.5/127/138.5",
#          group = "Rabbit Springs")
# 
# station_comp_others <- station_feature_wt_ndt %>% 
#   filter(feature %in% c("JT-74.5", "JT-77.4")) %>% 
#   select(group, feature, c, mn, si)
# 
# station_comp_groupings <- bind_rows(station_comp_others, station_comp_group1)
# 
# station_comp_pearlite <- station_comp_groupings %>% 
#   mutate(
#     "Eq. Pearlite (%)" = (c-.022)/(0.76-0.075*mn-0.1*si-.022)*100
#   ) %>% 
#   full_join(station_micro, by = c("group", "feature")
#   ) %>% 
#   select(
#     group,
#     feature,
#     c,
#     mn,
#     si,
#     "Eq. Pearlite (%)",
#     pct_dark_phase
#   )
# 
# flextable(station_comp_pearlite[1:3,-1]) %>% 
#   set_caption("This is the table caption.") %>% 
#   set_formatter(c = function(x) sprintf("%.02f", x),
#                 mn = function(x) sprintf("%.02f", x),
#                 si = function(x) sprintf("%.02f", x),
#                 'Eq. Pearlite (%)' = function(x) sprintf("%.00f", x),
#                 'pct_dark_phase' = function(x) sprintf("%.00f", x)) %>% 
#   set_header_labels(values = list(feature = 'Feature',
#                                   c = "C (wt%)",
#                                   mn = "Mn (wt%)",
#                                   si = "Si (wt%)",
#                                   pct_dark_phase = "Dark Phase (%)")) %>% 
#   align(j = -1, align = "center", part = "all") %>% 
#   autofit()

```


```{r GS, DP, and Grade, fig.width=8.5, fig.height=9}

# Appendix 2: Other correlations 

## GS, DP, and Grade

# plot1 <- eca_all_micro_complete %>% 
#   filter(!is.na(grade)) %>% 
#   ggplot(aes(grade, astm_grain_size)) +
#   geom_boxplot(fill="steelblue")+
#   geom_hline(data = station_micro , aes(yintercept = astm_grain_size, col = feature), lty = 2)+
#   coord_flip()
# 
# plot2 <- eca_all_micro_complete %>% 
#   filter(!is.na(grade))%>% 
#   ggplot(aes(grade, mean_linear_intercept)) +
#   geom_boxplot(fill="steelblue")+
#     geom_hline(data = station_micro , aes(yintercept = mean_linear_intercept, col = feature), lty = 2)+
#   coord_flip()
# 
# plot3 <- eca_all_micro_complete %>% 
#     filter(!is.na(grade))%>% 
#   ggplot(aes(grade, pct_dark_phase)) +
#   geom_boxplot(fill="steelblue")+
#     geom_hline(data = station_micro , aes(yintercept = pct_dark_phase, col = feature), lty = 2)+
#   coord_flip()
# 
# plot1 + plot3


```

 
```{r GS, DP, and Yield Strength, fig.height = 10, fig.width = 6.5}

## GS, DP, and Yield Strength 

# plot1 <- eca_all_micro_complete %>%
#   ggplot(aes(astm_grain_size, ten_ys)) +
#   geom_point(color = "steelblue") +   
#   geom_vline(data = station_micro, aes(xintercept = astm_grain_size, col = feature),lty = 2) +
#   facet_grid( ~ sample_type)
# 
# plot2 <- eca_all_micro_complete %>%
#   ggplot(aes(mean_linear_intercept, ten_ys)) +
#   geom_point(color = "steelblue") + 
#   geom_vline(data = station_micro, aes(xintercept = mean_linear_intercept, col = feature), lty = 2) + 
#   facet_grid( ~ sample_type)
# 
# plot3 <- eca_all_micro_complete %>%
#   ggplot(aes(pct_dark_phase, ten_ys)) +
#   geom_point(color = "steelblue") +   
#   geom_vline(data = station_micro, aes(xintercept = pct_dark_phase, col = feature), lty = 2) +   
#   facet_grid( ~ sample_type)
# 
# plot1 + plot3

```

```{r GS, DP, and Ultimate Tensile Strength, fig.height = 10, fig.width = 6.5}

## GS, DP, and Ultimate Tensile Strength


# plot1 <- eca_all_micro_complete %>% 
#   ggplot(aes(astm_grain_size, ten_uts)) +
#   geom_point(color="steelblue")+   
#   facet_grid( ~ sample_type)
# 
# plot2 <- eca_all_micro_complete %>% 
#   ggplot(aes(mean_linear_intercept, ten_uts)) +
#   geom_point(color="steelblue")+   
#   facet_grid( ~ sample_type)
# 
# plot3 <- eca_all_micro_complete %>% 
#   ggplot(aes(pct_dark_phase, ten_uts)) +
#   geom_point(color="steelblue")+   
#   facet_grid( ~ sample_type)
# 
# plot1 + plot3
```

```{r GS, DP, and Strain Hardening Exponent, fig.height = 10, fig.width = 6.5}

## GS, DP, and Strain Hardening Exponent


# plot1 <- eca_all_micro_complete %>% 
#   ggplot(aes(astm_grain_size, ten_n)) +
#   geom_point(color="steelblue")+   
# facet_grid( ~ sample_type)
# 
# plot2 <- eca_all_micro_complete %>% 
#   ggplot(aes(mean_linear_intercept, ten_n)) +
#   geom_point(color="steelblue")+   
# facet_grid( ~ sample_type)
# 
# plot3 <- eca_all_micro_complete %>% 
#   ggplot(aes(pct_dark_phase, ten_n)) +
#   geom_point(color="steelblue")+   
# facet_grid( ~ sample_type)
# 
# plot1 + plot3
```

```{r kable code}
# kable(station_comp_pearlite[1:3,], 
#              align=c(rep('c', times = 7)),
#              col.names = c("Group",
#                            "Feature",
#                            "C (wt%)",
#                            "Mn (wt%)",
#                            "Si (wt%)",
#                            "Eq. Pearlite (%)",
#                            "Dark Phase (%)"),
#              digits= c(0,0,2,2,2,0,0))

# knitr::kable(station_feature_wt_ndt, 
#              align = c(rep('c', times=9)), 
#              col.names = c("Group",
#                            "Feature", 
#                            "Type", 
#                            "Seam Type", 
#                            "Year", 
#                            "OD (in)", 
#                            "WT (in)", 
#                            "IIT Yield Strength (ksi)", 
#                            "IIT Tensile Strength (ksi)" ),
#              digits = c(1,1,1,1,1,1,3,1,1))  %>% 
#   remove_column(1)

```

